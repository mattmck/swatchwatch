#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get list of changed files in commits being pushed
CHANGED_FILES=$(git diff --name-only @{push}..HEAD 2>/dev/null || git diff --name-only origin/$(git branch --show-current)..HEAD 2>/dev/null || git diff --name-only HEAD~1..HEAD)

if [ -z "$CHANGED_FILES" ]; then
  echo "No changes detected, skipping build verification"
  exit 0
fi

echo "üîç Detecting changed workspaces..."

# Track what needs to be built
BUILD_SHARED=false
BUILD_WEB=false
BUILD_FUNCTIONS=false
VALIDATE_INFRA=false

# Check which parts were modified
echo "$CHANGED_FILES" | while IFS= read -r file; do
  case "$file" in
    packages/shared/*)
      BUILD_SHARED=true
      ;;
    apps/web/*)
      BUILD_WEB=true
      ;;
    packages/functions/*)
      BUILD_FUNCTIONS=true
      ;;
    infrastructure/*)
      VALIDATE_INFRA=true
      ;;
  esac
done

# Re-evaluate since loop runs in subshell
if echo "$CHANGED_FILES" | grep -q "^packages/shared/"; then
  BUILD_SHARED=true
fi
if echo "$CHANGED_FILES" | grep -q "^apps/web/"; then
  BUILD_WEB=true
fi
if echo "$CHANGED_FILES" | grep -q "^packages/functions/"; then
  BUILD_FUNCTIONS=true
fi
if echo "$CHANGED_FILES" | grep -q "^infrastructure/"; then
  VALIDATE_INFRA=true
fi

# Check for dependency changes - these affect all dependent packages
if echo "$CHANGED_FILES" | grep -qE "(^|/)package\.json$|^package-lock\.json$"; then
  echo "üìã Dependency changes detected"
  if echo "$CHANGED_FILES" | grep -qE "^packages/shared/(package\.json|package-lock\.json)$"; then
    echo "  ‚Üí packages/shared dependencies changed"
    BUILD_SHARED=true
    BUILD_WEB=true
    BUILD_FUNCTIONS=true
  fi
  if echo "$CHANGED_FILES" | grep -qE "^apps/web/(package\.json|package-lock\.json)$"; then
    echo "  ‚Üí apps/web dependencies changed"
    BUILD_WEB=true
  fi
  if echo "$CHANGED_FILES" | grep -qE "^packages/functions/(package\.json|package-lock\.json)$"; then
    echo "  ‚Üí packages/functions dependencies changed"
    BUILD_FUNCTIONS=true
  fi
  if echo "$CHANGED_FILES" | grep -qE "^(package\.json|package-lock\.json)$"; then
    echo "  ‚Üí Root dependencies changed - validating all workspaces"
    BUILD_SHARED=true
    BUILD_WEB=true
    BUILD_FUNCTIONS=true
  fi
fi

# Build shared first if needed (other packages depend on it)
if [ "$BUILD_SHARED" = true ]; then
  echo "üì¶ Building packages/shared..."
  npm run build --workspace=packages/shared || exit 1
  # If shared changed, we need to rebuild everything that depends on it
  BUILD_WEB=true
  BUILD_FUNCTIONS=true
fi

# Build web app
if [ "$BUILD_WEB" = true ]; then
  echo "üåê Building apps/web..."
  npm run build:web || exit 1
fi

# Build functions
if [ "$BUILD_FUNCTIONS" = true ]; then
  echo "‚ö° Building packages/functions..."
  npm run build:functions || exit 1
fi

# Validate infrastructure
if [ "$VALIDATE_INFRA" = true ]; then
  echo "üèóÔ∏è  Validating infrastructure..."
  (cd infrastructure && terraform init -backend=false && terraform validate) || exit 1
fi

echo "‚úÖ All builds passed!"
exit 0
